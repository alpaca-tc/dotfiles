<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>ユーザ定義のセッション保存関数を設定する</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.session-set-cookie-params.html">session_set_cookie_params</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.session-start.html">session_start</a></div>
 <div class="up"><a href="ref.session.html">セッション関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.session-set-save-handler" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">session_set_save_handler</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">session_set_save_handler</span> &mdash; <span class="dc-title">ユーザ定義のセッション保存関数を設定する</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.session-set-save-handler-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>session_set_save_handler</strong></span>
    ( <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <code class="parameter">$open</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <code class="parameter">$close</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <code class="parameter">$read</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <code class="parameter">$write</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <code class="parameter">$destroy</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <code class="parameter">$gc</code></span>
   )</div>

  <p class="para rdfs-comment">
   PHP 5.4 以降は次のプロトタイプでも登録できます。
  </p>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>session_set_save_handler</strong></span>
    ( <span class="methodparam"><span class="type"><a href="class.sessionhandlerinterface.html" class="type SessionHandlerInterface">SessionHandlerInterface</a></span> <code class="parameter">$sessionhandler</code></span>
   [, <span class="methodparam"><span class="type">bool</span> <code class="parameter">$register_shutdown</code><span class="initializer"> = true</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   <span class="function"><strong>session_set_save_handler()</strong></span> は、セッションに
   関連するデータを保存および取得するために使用されるユーザ定義の
   セッション保存関数を設定します。この関数は、セッションデータを
   ローカルデータベースに保存する場合のように PHP セッションにより
   提供されるもの以外の保存方法を使用したい場合に有用です。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.session-set-save-handler-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   この関数には二種類のプロトタイプがあります。
   <dl>

    <dt>

     <span class="term"><em><code class="parameter">sessionhandler</code></em></span>
     <dd>

      <p class="para">
       <span class="interfacename"><a href="class.sessionhandlerinterface.html" class="interfacename">SessionHandlerInterface</a></span> を実装したクラス、たとえば
       <a href="class.sessionhandler.html" class="classname">SessionHandler</a> のインスタンスで、
       これをセッションハンドラとして登録する。PHP 5.4 以降限定。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">register_shutdown</code></em></span>
     <dd>

      <p class="para">
       <span class="function"><a href="function.session-register-shutdown.html" class="function">session_register_shutdown()</a></span> を
       <span class="function"><a href="function.register-shutdown-function.html" class="function">register_shutdown_function()</a></span> 関数として登録するかどうか。
      </p>
     </dd>

    </dt>

   </dl>


   あるいは

   <dl>

    <dt>

     <span class="term"><em><code class="parameter">open(string $savePath, string $sessionName)</code></em></span>
     <dd>

      <p class="para">
       open コールバックはクラスのコンストラクタのようなもので、セッションを開くときに実行されます。
       セッションが自動で開始したり、あるいは手動で <span class="function"><a href="function.session-start.html" class="function">session_start()</a></span>
       で開始させたりするときに、最初に実行されるコールバック関数がこれです。
       成功した場合は <strong><code>TRUE</code></strong>、失敗した場合は <strong><code>FALSE</code></strong> を返します。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">close()</code></em></span>
     <dd>

      <p class="para">
       close コールバックはクラスのデストラクタのようなもので、write コールバックがコールされた後で実行されます。
       また、<span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span> がコールされたときにも実行されます。
       成功した場合は <strong><code>TRUE</code></strong>、失敗した場合は <strong><code>FALSE</code></strong> を返します。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">read(string $sessionId)</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">read</code></em> コールバックは、常にセッションエンコード (シリアライズ)
       された文字列を返さなければなりません。何もデータを読み込まなかった場合は空文字列を返します。
      </p>
      <p class="para">
       このコールバックは、セッションが開始したときや
       <span class="function"><a href="function.session-start.html" class="function">session_start()</a></span> がコールされたときに PHP が内部的に実行します。
       このコールバックを実行する前に、PHP は
       <em><code class="parameter">open</code></em> コールバックを実行します。
      </p>
      <p class="para">
       このコールバックが返す値は、
       <em><code class="parameter">write</code></em> コールバックがストレージに渡した形式とまったく同じシリアライズ形式でなければなりません。
       返された値を PHP が自動的にアンシリアライズして、スーパーグローバル <var class="varname"><var class="varname"><a href="reserved.variables.session.html" class="classname">$_SESSION</a></var></var>
       に格納します。データの形式は <span class="function"><a href="function.serialize.html" class="function">serialize()</a></span> したものと似ていますが、実際は違う形式であることに注意しましょう。
       シリアライズの方法は ini 設定 <a href="session.configuration.html#ini.session.serialize-handler" class="link">session.serialize_handler</a> で指定します。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">write(string $sessionId, string $data)</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">write</code></em> コールバックは、セッションの保存や終了が必要となったときにコールされます。
       このコールバックが受け取るのは、現在のセッション ID とシリアライズ後のスーパーグローバル <var class="varname"><var class="varname"><a href="reserved.variables.session.html" class="classname">$_SESSION</a></var></var> です。
       PHP が内部で利用するシリアライズ方法は、ini 設定
       <a href="session.configuration.html#ini.session.serialize-handler" class="link">session.serialize_handler</a> で指定します。
      </p>
      <p class="para">
       このコールバックに渡されたシリアライズ後のセッションデータを、
       渡されたセッション ID に対応させて格納しなければなりません。
       このデータを取得した <em><code class="parameter">read</code></em> コールバックは、
       <em><code class="parameter">write</code></em> コールバックに最初に渡されたのとまったく同じ値を返さなければなりません。
      </p>
      <p class="para">
       このコールバックが実行されるのは、PHP のスクリプトが終了するときか、あるいは明示的に <span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span>
       がコールされたときです。この関数の実行後には、PHP が内部的に <em><code class="parameter">close</code></em>
       コールバックを実行することに注意しましょう。
       <blockquote class="note"><p><strong class="note">注意</strong>: 
        <p class="para">
         &quot;write&quot; ハンドラは、出力ストリームが閉じてから実行されます。
         したがって、&quot;write&quot; ハンドラ内でデバッグ出力を行っても、
         それはブラウザに表示されません。
         デバッグ出力が必要なら、それをファイルに書き出すようにしましょう。
        </p>
       </p></blockquote>
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">destroy($sessionId)</code></em></span>
     <dd>

      <p class="para">
       このコールバックが実行されるのは、
       <span class="function"><a href="function.session-destroy.html" class="function">session_destroy()</a></span> あるいは
       <span class="function"><a href="function.session-regenerate-id.html" class="function">session_regenerate_id()</a></span> (destroy パラメータを <strong><code>TRUE</code></strong> にした場合)
       を実行し、セッションを破棄した場合です。
       成功した場合は <strong><code>TRUE</code></strong>、失敗した場合は <strong><code>FALSE</code></strong> を返します。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">gc($lifetime)</code></em></span>
     <dd>

      <p class="para">
       ガベージコレクタコールバックは PHP が内部で定期的に実行し、古いセッションデータを破棄します。
       実行頻度は <a href="session.configuration.html#ini.session.gc-probability" class="link">session.gc_probability</a>
       および <a href="session.configuration.html#ini.session.gc-divisor" class="link">session.gc_divisor</a> で設定します。
       この関数に渡される有効期限の値は <a href="session.configuration.html#ini.session.gc-maxlifetime" class="link">session.gc_maxlifetime</a>
       で設定できます。
       成功した場合は <strong><code>TRUE</code></strong>、失敗した場合は <strong><code>FALSE</code></strong> を返します。
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.session-set-save-handler-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合に <strong><code>TRUE</code></strong> を、失敗した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.session-set-save-handler-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4339">
    <p><strong>例1 
     <span class="function"><strong>session_set_save_handler()</strong></span> で <a href="class.sessionhandlerinterface.html" class="classname">SessionHandlerInterface</a> を使う例
    </strong></p>
    <div class="example-contents"><p>
     このコードは、PHP 5.4.0 以降のバージョンで動作します。
    </p></div>
    <div class="example-contents"><p>
     この例では、ファイルベースのセッションストレージをつくります。これは
     PHP のデフォルトのセッション保存ハンドラである <em><code class="parameter">files</code></em>
     と似たものです。この例をさらに拡張すれば、
     PHP がサポートするお好みのデータベースを使ってセッションを保存させるようにするのも簡単です。
    </p></div>
    <div class="example-contents"><p>
     <span class="function"><strong>session_set_save_handler()</strong></span> でオブジェクト指向型のプロトタイプを使っていることと、
     シャットダウン関数をその parameter フラグで登録していることに注目しましょう。
     オブジェクトをセッション保存ハンドラとして使うときには、この方法をおすすめします。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">MySessionHandler&nbsp;</span><span style="color: #007700">implements&nbsp;</span><span style="color: #0000BB">SessionHandlerInterface<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$savePath</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">open</span><span style="color: #007700">(</span><span style="color: #0000BB">$savePath</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sessionName</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$savePath</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">is_dir</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mkdir</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0777</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">close</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(string)@</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$savePath</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&nbsp;===&nbsp;</span><span style="color: #0000BB">false&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">false&nbsp;</span><span style="color: #007700">:&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">destroy</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$file&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">gc</span><span style="color: #007700">(</span><span style="color: #0000BB">$maxlifetime</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">glob</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #DD0000">/sess_*"</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$file</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">filemtime</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">)&nbsp;+&nbsp;</span><span style="color: #0000BB">$maxlifetime&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">time</span><span style="color: #007700">()&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$handler&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MySessionHandler</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">session_set_save_handler</span><span style="color: #007700">(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">session_start</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;$_SESSION&nbsp;への値の設定や格納されている値の取得を進めます</span>
</span>
</code></div>
    </div>

   </div>
   <div class="example" id="example-4340">
    <p><strong>例2 セッション保存ハンドラでオブジェクトを使う例</strong></p>
    <div class="example-contents"><p>
     このコードは、PHP 5.4.0 より前のバージョンで動作します。
    </p></div>
    <div class="example-contents"><p>
     この例では、ファイルベースのセッションストレージをつくります。これは
     PHP のデフォルトのセッション保存ハンドラである <em><code class="parameter">files</code></em>
     と似たものです。この例をさらに拡張すれば、
     PHP がサポートするお好みのデータベースを使ってセッションを保存させるようにするのも簡単です。
    </p></div>
    <div class="example-contents"><p>
     シャットダウン関数 <span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span> を、
     <span class="function"><a href="function.register-shutdown-function.html" class="function">register_shutdown_function()</a></span> を使って追加登録していることに注目しましょう。
     PHP 5.4.0 より前のバージョンでオブジェクトをセッション保存ハンドラとして使うときには、この方法をおすすめします。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">FileSessionHandler<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$savePath</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">open</span><span style="color: #007700">(</span><span style="color: #0000BB">$savePath</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sessionName</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$savePath</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">is_dir</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mkdir</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0777</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">close</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(string)@</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$savePath</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&nbsp;===&nbsp;</span><span style="color: #0000BB">false&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">false&nbsp;</span><span style="color: #007700">:&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">destroy</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$file&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">gc</span><span style="color: #007700">(</span><span style="color: #0000BB">$maxlifetime</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">glob</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">savePath</span><span style="color: #DD0000">/sess_*"</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$file</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">filemtime</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">)&nbsp;+&nbsp;</span><span style="color: #0000BB">$maxlifetime&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">time</span><span style="color: #007700">()&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$handler&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">FileSessionHandler</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">session_set_save_handler</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'open'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'close'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'read'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'write'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'destroy'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'gc'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;);<br /><br /></span><span style="color: #FF8000">//&nbsp;これは、オブジェクトを保存ハンドラとして使ったときの予期せぬ副作用を防ぎます<br /></span><span style="color: #0000BB">register_shutdown_function</span><span style="color: #007700">(</span><span style="color: #DD0000">'session_write_close'</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">session_start</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;$_SESSION&nbsp;への値の設定や格納されている値の取得を進めます</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.session-set-save-handler-notes">
  <h3 class="title">注意</h3>
  <div class="warning"><strong class="warning">警告</strong>
   <p class="para">
    オブジェクトをセッション保存ハンドラとして使うときには、
    シャットダウン関数を PHP に登録しておくことが重要です。
    これで、PHP スクリプトの終了時に内部的にオブジェクトを破棄する処理による副作用や、
    <em><code class="parameter">write</code></em> および <em><code class="parameter">close</code></em>
    がコールされてしまうことを防げます。
    一般的には、<em><code class="parameter">&#039;session_write_close&#039;</code></em> を
    <span class="function"><a href="function.register-shutdown-function.html" class="function">register_shutdown_function()</a></span> 関数で登録しなければなりません。
   </p>
   <p class="para">
    PHP 5.4.0 以降では <span class="function"><a href="function.session-register-shutdown.html" class="function">session_register_shutdown()</a></span>
    を使えます。あるいは <span class="function"><strong>session_set_save_handler()</strong></span>
    をオブジェクト指向のメソッドとして実行するときに &#039;register shutdown&#039;
    フラグを使い、<a href="class.sessionhandlerinterface.html" class="classname">SessionHandlerInterface</a>
    を実装したインスタンスを渡すという方法もあります。
   </p>
  </div>
  <div class="warning"><strong class="warning">警告</strong>
   <p class="para">
    PHP 5.0.5 以降、<em><code class="parameter">write</code></em> ハンドラおよび
    <em><code class="parameter">close</code></em> ハンドラはオブジェクトが破棄されたあとにコールされます。
    そのため、これらのハンドラでオブジェクトを使ったり例外をスローしたりすることはできません。
    例外をキャッチできないのでその情報をトレースすることもできず、
    例外は単純に無視されてしまいます。
    しかし、オブジェクトのデストラクタではセッションを使えます。
   </p>
   <p class="para">
    この「ニワトリが先かタマゴが先か」の問題を解決するために、
    デストラクタから <span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span>
    をコールできますが、より確実なのは先述のとおりシャットダウン関数を登録することです。
   </p>
  </div>
  <div class="warning"><strong class="warning">警告</strong>
   <p class="para">
    SAPI の種類によっては、スクリプトの終了時にセッションを閉じると
    現在の作業ディレクトリが変わってしまうことがあります。これを防ぐには、
    事前に <span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span> でセッションを閉じます。
   </p>
  </div>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.session-set-save-handler-changelog">
  <h3 class="title">変更履歴</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>バージョン</th>
      <th>説明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>5.4.0</td>
      <td>
       <span class="interfacename"><a href="class.sessionhandlerinterface.html" class="interfacename">SessionHandlerInterface</a></span> と
       <a href="class.sessionhandler.html" class="classname">SessionHandler</a> を追加し、
       セッションハンドラを実装できるようになりました。
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 seealso" id="refsect1-function.session-set-save-handler-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member">
     設定ディレクティブ <a href="session.configuration.html#ini.session.save-handler" class="link">session.save_handler</a>
    </li>
    <li class="member"><span class="function"><a href="function.register-shutdown-function.html" class="function" rel="rdfs-seeAlso">register_shutdown_function()</a> - シャットダウン時に実行する関数を登録する</span></li>
    <li class="member"><span class="function"><a href="function.session-register-shutdown.html" class="function" rel="rdfs-seeAlso">session_register_shutdown()</a> - セッションのシャットダウン関数</span> (PHP 5.4.0 以降)</li>
   </ul>
  </p>
 </div>


</div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.session-set-cookie-params.html">session_set_cookie_params</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.session-start.html">session_start</a></div>
 <div class="up"><a href="ref.session.html">セッション関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
